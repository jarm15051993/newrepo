generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  lastName  String
  phone     String   @unique
  birthday  DateTime
  additionalInfo  String?
  profilePicture  String?
  activationToken String?  @unique
  activatedAt     DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  credits             UserCredit[]
  bookings            Booking[]
  transactions        Transaction[]
  payments            Payment[]
  passwordResetTokens PasswordResetToken[]
  emailLogs           EmailLog[]
}

model Package {
  id          String   @id @default(cuid())
  name        String
  description String?
  classCount  Int
  price       Float
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  transactions Transaction[]
  payments     Payment[]
}

model UserCredit {
  id              String   @id @default(cuid())
  userId          String
  creditsRemaining Int
  creditsTotal    Int
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Class {
  id          String   @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  capacity    Int
  bookedCount Int      @default(0)
  instructor  String?
  createdAt   DateTime @default(now())

  bookings Booking[]
}

model Booking {
  id        String   @id @default(cuid())
  userId    String
  classId   String
  stretcherNumber Int
  status    String   @default("confirmed")
  createdAt DateTime @default(now())
  
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@unique([userId, classId])
  @@unique([classId, stretcherNumber])
}

model Transaction {
  id              String   @id @default(cuid())
  userId          String
  packageId       String
  amount          Float
  stripePaymentId String?
  status          String
  createdAt       DateTime @default(now())
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id])
}

model Payment {
  id                String   @id @default(cuid())
  userId            String
  packageId         String
  amount            Float
  stripeSessionId   String   @unique
  stripePaymentId   String?
  status            String   @default("pending")
  createdAt         DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id        String   @id @default(cuid())
  type      String   @unique
  subject   String
  htmlBody  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailLog {
  id       String   @id @default(cuid())
  userId   String?
  to       String
  type     String
  subject  String
  status   String
  metadata Json?
  sentAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}